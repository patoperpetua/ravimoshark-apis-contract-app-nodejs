# RAVIMOSHARK - APIS - CONTRACT - NodeJS APP

## Overview

This server was generated by the [swagger-codegen](https://github.com/swagger-api/swagger-codegen) project.  By using the [OpenAPI-Spec](https://github.com/OAI/OpenAPI-Specification) from a remote server, you can easily generate a server stub.

## TODO

* [ ] Setup docker image.
* [ ] Setup test environment.
* [ ] Connect Database with an ORM.
* [ ] Add lint rules.
* [ ] Config TS.
* [ ] Config Keyclock to authenticate.

## BRANCHING MODEL

----------------------

* Default branch when pull is DEVELOP.
* Master branch is protected and it is not possible to push. Create a merge request instead.

## DEPLOYMENT

----------------------

* **MASTER BRANCH:**
  * It creates a docker image using the following tags:
    * ravimosharksas/apis/contract/app:latest.
  * Trigger a job in every client library only if api.json has change. It generates a new library version. Libraries are:
    * [api angular client](https://gitlab.com/ravimosharksas/apis/contract/libs/angular-client.git)
* **DEVELOP BRANCH:**
  * It creates a docker image using the following tags:
    * ravimosharksas/apis/contract/app:develop.
  * Trigger a job in every client library only if api.json has change. It generates a new library version following by develop tag. Libraries are:
    * [api angular client](https://gitlab.com/ravimosharksas/apis/contract/libs/angular-client.git)

## RUNNING SERVER

----------------------

After running using either way, you can access the api under:

```bash
http://localhost:3000/
```

To view the Swagger UI interface:

```bash
open http://localhost:3000/docs
```

### USING DOCKER

To use this container with docker, just type `docker-compose up` or `npm run docker-run${ENV}`. ENV can be empty for production or `:dev` for development.

Also you can connect to the database under port 1433. Password is set under docker-compose.yml file. You can change this configuration by adding an .env file in the root folder.

### USING NPM

To run the server, type:

```bash
npm install
npm start
```

### DEFAULT API TOKEN

<!-- TODO: -->

## ENVIRONMENT VARIABLES

----------------------

* `API_VERSION`: api version image. Default: latest.
* `SWAGGER_HOST`: url of api. Default: localhost:3000.
* `SWAGGER_BASE_PATH`: path inside url api. Default: /.
* `DB_MAIN_CLIENT`: main database connection name. Default: docker.
* `DATABASE_FILE`: file where database connections details are saved. Default: assets/database.json.
* `PORT_APP`: port to connect to the api. Default: 3000.
* `PORT_DB`: port to connect to mysql container. Default: 3306.
* `DATA_DB`: location of database data. Default: data/db.
* `DEVELOPMENT`: if image is use to develop. Default: false.

## API TOKENS

<!-- TODO: tell how to connect with KeyClock. -->

## DATABASE CONNECTIONS

----------------------

In order to connect the api with a database, there are 3 thing to consider:

1. A definition must me placed in **.env** file called *DB_MAIN_CLIENT*.
2. To use a database inside a docker container, place the definition *DATABASE_LOCAL=1* inside **.env** file.
3. A file called **database.json** must be created following the next prototype:

**NOTE:** by default the api will try to connect to a container database called (url name) database.

```json
{
    "MAIN_DB":{
        "development":{
            "client": "mongo",
            "connection": {
            "host"     : "127.0.0.1",
            "user"     : "root",
            "password" : "PassWord",
            "database" : "vacas",
            "charset"  : "utf8"
            }
        },
        "docker":{
            "client": "mongo",
            "connection": {
            "host"     : "database",
            "user"     : "root",
            "password" : "DockerPassWORD",
            "database" : "vacas",
            "charset"  : "utf8"
            }
        },
        "production":{
            "client": "mongo",
            "connection": {
            "host"     : "127.0.0.1",
            "user"     : "",
            "password" : "",
            "database" : "vacas",
            "charset"  : "utf8"
            }
        }
    }
}
```

----------------------
Â© [Singleton SD](http://singletonsd.com), France, 2019.
